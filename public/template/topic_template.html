<% // Check to see if there is a topic defined.  If not, define one


	if ( (typeof topics == 'undefined') ||  (topics.length < 1)) {
		console.log("No topics");
		topics = [{title:"", details:""}]; 
	}


	if ( (typeof readings == 'undefined') ||  (readings.length < 1)) {
		console.log("No readings");
		readings = []; 
	}	

	// Loop through each topic, printing out the information
	_.each(topics, function(topic, index, list) { %>

		<div class="panel panel-default topic_box">
			<div class="panel-heading">
				<span class="panel-title topic_heading"></span>
				<div class="btn-group pull-right">
					<button type="button" class="btn btn-primary btn-sm add_topic">Add a Topic</button>
					<button type="button" class="btn btn-danger btn-sm delete_topic">Delete Topic</button>
				</div>
				<div class="clearfix"></div>
			
			</div> <!-- End of panel-heading -->
	
	
			<div class="panel-body">
	
				<div class="form-group" >
					<label class="col-sm-1 control-label">Topic</label>
					<div class="col-sm-10">
						<input type="text" class="form-control topic_title" placeholder="Enter topic" value="<% if (topic.title) { print(topic.title); } %>">
					</div>
				</div>	

				<div class="form-group" >
					<label class="col-sm-1 control-label">Details</label>
					<div class="col-sm-10">
						<textarea class="form-control topic_details" rows="3" placeholder="Topic details"><%= topic.details %></textarea>
					</div>
				</div>	

				<div class="clearfix"></div>

				<div class="table-responsive col-lg-12 reading_list">
					<label class="control-label">Reading list</label>
					<table class="table table-striped " >
						<thead>
							<tr>
								<th>OCLC&nbsp;#</th>
								<th>Citation</th>
								<th>Pages</th>
								<th>Remove</th>
							</tr>
						</thead>
						<!-- Individual reading entries go here-->
						<%  var readings_for_this_topic = _.filter(readings, function(reading) {
												return reading.topic == index+1;
											});
											
							console.log("Readings!");
							console.log(readings);
							console.log(readings_for_this_topic	);		
											
							_.each(readings_for_this_topic, function(reading, index, list) {
								var m = render("reading_entry_template", reading);
								print(m);
							});

						%>
	
					</table>	 <!-- End of reading_list -->
				</div>
		
				<!-- Button for adding a new reading via OCLC search -->
				<div class="col-lg-6">
					<label class="control-label">Search for a reading in WorldCat</label>
					<div class="input-group">
					  <input type="text" class="form-control">
					  <span class="input-group-btn search_reading" >
						<button class="btn btn-default " type="button" data-loading-text="Searching...">Search</button>
					  </span>
					</div><!-- /input-group -->
				  </div><!-- /.col-lg-6 -->


				<!-- Button for adding a new reading manually-->
				<div class="col-lg-6">
					<label class="control-label">Manually enter a reading</label>
					<div class="input-group">
					  <input type="text" class="form-control manual_reading_title">
					  <span class="input-group-btn add_manual_reading" >
						<button class="btn btn-default" type="button">Add</button>
					  </span>
					</div><!-- /input-group -->
				  </div><!-- /.col-lg-6 -->


			</div> <!-- End of panel-body -->
	
		</div> <!-- End of panel -->


	<% }); %>

<!-- code to add and remove readings -->
<script>

	$(".add_topic").unbind("click");	// Remove existing events
	$(".add_topic").click(function() {
		var this_topic = $(this).closest(".topic_box");
		number_of_topics = $("#topics .topic_box").length;
		var m = render("topic_template");
		$(m).insertAfter(this_topic).slideDown();
		renumber_topics();
	});	

	
	$(".delete_topic").click(function() {
	
		// Find the div with class reading_entry that contains this button and remove it
		$(this).closest(".topic_box").slideUp(
			function() {
				$(this).remove();
			}
		);
		renumber_topics();
	});


	// Add a new manual reading
	$(".add_manual_reading").click(function() {

		var reading_list = $(this).closest(".topic_box").find(".reading_list > table");
		var title = $(this).closest(".topic_box").find(".manual_reading_title").val();
	
		// Make sure reading list div is visible
		$(this).closest(".topic_box").find(".reading_list").show();
		
		var m = render("reading_entry_template", {citation: title, oclc: null});
		$(m).appendTo(reading_list).slideDown();

	});


	// Search for a new reading.
	$(".search_reading").click(function() {
	
		// Set the search button to disabled
		$(this).find("button").button("loading");
		
		var topic_number = $(this).closest(".topic_box").index(".topic_box") + 1;
		var search_q = $(this).prev().val();	
		socket.emit("search_oclc", {q:search_q, topic:topic_number});		
	});



	function renumber_topics() {
		// Find all topics and put the correct number in the topic heading
		$(".topic_box").each(function(index, element) {
			$(element).find(".topic_heading").html("Topic " + (index + 1));
		});
	}
	
	function show_non_empty_reading_lists() {
		// Go through all the topics, and show reading lists with content
		$(".topic_box").each(function(index, element) {
			var rl = $(element).find(".reading_list");
			if (rl.find("tbody tr").length > 0) {
				console.log("reading list with content");
				rl.show();
			}
		});	
	}

	// Run renumber
	renumber_topics();
	
	show_non_empty_reading_lists();

</script>
