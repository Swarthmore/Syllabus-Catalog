<!DOCTYPE html>
<head>
    <title>Rangy Highlighter Module Demo</title>
  
    <link href="/css/rangy.css" rel="stylesheet" type="text/css">
   
    <style type="text/css">
        .highlight_topic {
            background-color: yellow;
        }


        .highlight_reading {
            background-color: green;
        }        

        .highlight_assignment {
            background-color: blue;
        }

        .note {
            background-color: limegreen;
        }
        
        #summary {
            border: dotted orange 1px;
        }

    </style>

	<script src="/js/lib/jquery.min.js"></script>

    <script type="text/javascript" src="/js/lib/rangy/log4javascript_stub.js"></script>
    <script type="text/javascript" src="/js/lib/rangy/core.js"></script>
    <script type="text/javascript" src="/js/lib/rangy/dom.js"></script>
    <script type="text/javascript" src="/js/lib/rangy/domrange.js"></script>
    <script type="text/javascript" src="/js/lib/rangy/wrappedrange.js"></script>
    <script type="text/javascript" src="/js/lib/rangy/wrappedselection.js"></script>
    <script type="text/javascript" src="/js/lib/rangy/rangy-cssclassapplier.js"></script>

    <script type="text/javascript" src="/js/lib/rangy/rangy-highlighter.js"></script>
    
    
    
    
    <script type="text/javascript">

        var serializedHighlights = decodeURIComponent(window.location.search.slice(window.location.search.indexOf("=") + 1));
        var highlighter;

        var initialDoc;

        var highlight_mode = "highlight_topic";






        $( document ).ready(function() {

        	// Handle key presses
        	$("#content_iframe" ).load(function() {
        		console.log("Setting up iFrame keypress");
        		
				$( $("#content_iframe" ).get(0).contentWindow.document).keyup(function(event) {
					handle_keypress(event)
				});
				
				
				setup_rangy();	
			});

			rangy.init();
			
		});
      
            

            


        // Based on keypress, take appropriate action
        function handle_keypress(event) {

        	console.log("Received keypress with code: " + event.which);

        	switch(event.which) {

        		case 49: // 1
        			highlightSelectedText("highlight_topic");
        			break;
        		case 50: // 2
        			highlighter.highlightSelection( "highlight_reading" );
        			break;
        		case 51: // 3
        			highlighter.highlightSelection( "highlight_assignment" );
        			break;

        		case 82: // R
        		case 114: // r
        			removeHighlightFromSelectedText();
        			break;    			
        	}
        	
        }




		function setup_rangy() {
		
			highlighter = rangy.createHighlighter($("#content_iframe" ).get(0).contentWindow.document);

            highlighter.addClassApplier(rangy.createCssClassApplier("highlight_topic", {
                ignoreWhiteSpace: true,
                tagNames: ["span", "a"]
            }));

            highlighter.addClassApplier(rangy.createCssClassApplier("highlight_reading", {
                ignoreWhiteSpace: true,
                tagNames: ["span", "a"]
            }));            

            highlighter.addClassApplier(rangy.createCssClassApplier("highlight_assignment", {
                ignoreWhiteSpace: true,
                tagNames: ["span", "a"]
            }));  


            highlighter.addClassApplier(rangy.createCssClassApplier("note", {
                ignoreWhiteSpace: true,
                elementTagName: "a",
                elementProperties: {
                    href: "#",
                    onclick: function() {
                        var highlight = highlighter.getHighlightForElement(this);
                        if (window.confirm("Delete this note (ID " + highlight.id + ")?")) {
                            highlighter.removeHighlights( [highlight] );
                        }
                        return false;
                    }
                }
            }));


            if (serializedHighlights) {
                highlighter.deserialize(serializedHighlights);
            }
            
            var style = document.createElement('style');
			style.type = 'text/css';
			style.innerHTML = '.highlight_topic { background-color: yellow; opacity:0.2;}';
			$("#content_iframe" ).get(0).contentWindow.document.getElementsByTagName('head')[0].appendChild(style);
            
        
		}


        function highlightSelectedText(highlight_mode) {
        	// Get selection from iFrame
        	var iframe = document.getElementById("content_iframe");
        	var sel = rangy.getSelection(iframe);
        	console.log(sel.toString());
        	console.log(sel.getAllRanges());
        	//highlighter.highlightSelection(highlight_mode);  
        	
        	highlightApplier = rangy.createCssClassApplier("highlight_topic", {elementTagName: 'span'});
        	highlightApplier.applyToSelection($("#content_iframe")[0].contentWindow.window);
        	
        	highlight_summary();
        }

        function noteSelectedText() {
            highlighter.highlightSelection("note");
        }

        function removeHighlightFromSelectedText() {
            highlighter.unhighlightSelection();
            highlight_summary() ;
        }

        function highlightScopedSelectedText() {
            highlighter.highlightSelection("highlight", null, "summary");
        }

        function noteScopedSelectedText() {
            highlighter.highlightSelection("note", null, "summary");
        }



        function highlight_summary() {
        	console.log("Topics:");
        	var topic_listing = $($("#content_iframe" ).get(0).contentWindow.document).find(".highlight_topic").each(function (index) {
        		console.log("Topic " + (index+1) + ": " + $(this).text());
        	});
        }


        function reloadPage(button) {
            button.form.elements["serializedHighlights"].value = highlighter.serialize();
            button.form.submit();
        }

    </script>
</head>
<body>
    <div id="buttons">
        <h3>Highlighter</h3>
        <p>Make a selection in the document and use the buttons below to highlight and unhighlight.</p>

        <input type="button" ontouchstart="highlightSelectedText();" onclick="highlightSelectedText();" value="Highlight selection">
        <input type="button" ontouchstart="noteSelectedText();" onclick="noteSelectedText();" value="Add note to selection">
        <input type="button" ontouchstart="removeHighlightFromSelectedText();" onclick="removeHighlightFromSelectedText();" value="Remove highlights from selection">
        <br>
        <input type="button" ontouchstart="highlightScopedSelectedText();" onclick="highlightScopedSelectedText();" value="Highlight within outlined paragraph">
        <input type="button" ontouchstart="noteScopedSelectedText();" onclick="noteScopedSelectedText();" value="Annotate selection within outlined paragraph">

        <h3>Preserving highlights between page requests</h3>
        <form action="highlighter.html" method="get">
            Highlights can be preserved between page requests. Press the following button to reload the page with the
            highlights preserved:
            <br>
            <input type="hidden" name="serializedHighlights" value="">
            <input type="button" value="Reload" onclick="reloadPage(this)">
        </form>
    </div>

    <div id="content" style="width:80%;height:100%">
    		<iframe id="content_iframe" src="/web/viewer.html?file=/Syllabi/Buurma, English 44, 20th Century Novel.pdf" style="width:100%;height:100%"></iframe>


 	</div> 
</body>
</html>